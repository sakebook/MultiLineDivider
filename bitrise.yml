---
format_version: '3'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android
workflows:
  run-test-docker:
    steps:
    - activate-ssh-key@3.1.1:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@3.5.0: {}
    - cache-pull@1.0.0: {}
    - script@1.1.4:
        title: run test use docker
        inputs:
        - content: |-
            rm -rf local.properties

            docker run --rm \
              -v $BITRISE_SOURCE_DIR:$DOCKER_HOME \
              -w $DOCKER_HOME \
              -e GRADLE_USER_HOME=$DOCKER_HOME/.gradle \
              -e BITRISE_IO=true \
              -e GIT_REPOSITORY_URL=$GIT_REPOSITORY_URL \
              -e BITRISE_PULL_REQUEST=$BITRISE_PULL_REQUEST \
              $DOCKERHUB_IMG_ID bash -c \
                "
                bundle install
                bundle exec danger
                ./gradlew :multilinedivider:testDebug -PdisablePreDex
                "
    - cache-push@1.1.3:
        inputs:
        - cache_paths: |-
            $BITRISE_SOURCE_DIR/.gradle
            $BITRISE_SOURCE_DIR/.m2
            $HOME/.gradle
        - ignore_check_on_paths: |-
            $HOME/.gradle/caches/*.lock
            $HOME/.gradle/*.bin
            $BITRISE_SOURCE_DIR/.gradle/*.lock
            $BITRISE_SOURCE_DIR./.gradle/*.bin
    before_run:
    - docker-build
  run-test:
    steps:
    - activate-ssh-key@3.1.1:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@3.5.0: {}
    - cache-pull@1.0.0: {}
    - script@1.1.4:
        title: run danger
        inputs:
        - content: |-
            bundle install
            bundle exec danger
    - gradle-unit-test@1.0.2:
        inputs:
        - unit_test_task: ":multilinedivider:testDebug -PdisablePreDex"
    - cache-push@1.1.3: {}
  docker-build:
    steps:
    - script@1.1.4:
        title: docker login & pull
        inputs:
        - content: |-
            docker login -u $USERNAME -p $PASSWORD
            docker pull $DOCKERHUB_IMG_ID
app:
  envs:
  - GRADLEW_PATH: "./gradlew"
  - GRADLE_BUILD_FILE_PATH: build.gradle
  - DOCKER_HOME: "/root"
  - DOCKERHUB_IMG_ID: sakebook/docker-android-alpine:25.0.3_3
trigger_map:
- pull_request_source_branch: "*"
  workflow: run-test-docker
